#!/usr/bin/env python3

import os
import json
from ramda import *

SOURCES = './ramda/'

docs = map(evolve(
    {'name': replace(r'^_', '')}),
    json.load(open('./jsdocs.json')))

filter_functions = filter(both(test(r'.py$'), complement(test('_test'))))
clear_description = replace(r'\.?\n$', '')

files = filter_functions(os.listdir(SOURCES))
cutPy = replace(r'.py$', '')

for filename in files:
    name = cutPy(filename)
    source = open(SOURCES + filename).read()

    func = find(prop_eq('name', name), docs)

    if not func:
        print(f'{name} has no description')
        continue

    doc_string = f'\n    """{clear_description(func["description"])}"""\n'

    modified = if_else(
        test('"""'),
        replace(fr'\n\s+"""(.*\n)*.*"""\n', doc_string),
        replace(fr'(def {name}.*:)\n', rf'\1{doc_string}'),
        source)

    open(SOURCES + filename, 'w').write(modified)


print('\n\nnot done:')
apply(print, juxt([join('\n'), length])(difference(
    pluck('name', docs),
    map(cutPy, files)
)))
